---
title: "R-code for 'Effects of hunting on black grouse inbreeding and dispersal'"
author: "compiled by Rebecca Shuhua Chen"
date: "04/10/2022"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
---
---

This document contains all R-code used in the workflow for the manuscript *"Effects of hunting on genetic diversity, inbreeding and dispersal in Finnish black grouse (Lyrurus tetrix)"* by Rebecca Shuhua Chen, Carl Soulsbury, Christophe Lebigre, Kees van Oers and Joseph Hoffman (in review). The raw data can be found in the public GitHub repository together with full R scripts and processed datafiles. Please contact me at rebecca.chen@uni-bielefeld.de for any questions.

Within this markdown file, we follow the same order of analyses as described in the Materials and Methods. However, not all analyses are executed in R, and other softwares were used in combination with our workflow in R to collect all results presented in the manuscript.

---

# Libraries
The following packages were used in the analyses:

```{r libraries, error=FALSE, warning=FALSE, message=F}
<<<<<<< HEAD
pacman::p_load(tidyverse, adegenet, pegas, data.table, hierfstat, 
               plot.matrix, lme4, forcats, ape, ParallelStructure, pophelper, 
               inbreedR, lmerTest, DHARMa, performance, MuMIn, readxl, glmmTMB, 
               RColorBrewer, extrafont, devtools, gridExtra)
=======
pacman::p_load(tidyverse, adegenet,pegas,data.table,hierfstat,plot.matrix,lme4,forcats,ape,ParallelStructure,
               pophelper,inbreedR,lmerTest,DHARMa,performance,MuMIn,readxl,glmmTMB,RColorBrewer,extrafont,devtools,
               gridExtra)
>>>>>>> 6c4f24870e7129458f5cbcd90bc70e6d09803588
```

# Data

Raw datasheets are provided in three different formats: 1) unsplit genotypes
with one row per individual, 2) STRUCTURE (.stru) datafiles with two consecutive rows per individual, one row per allele. In both these files,
populations are coded as integers. Thirdly, a full, easy to read .RData can be 
found including all details on the sites and hunted status, as well as sex.

```{r data, warning=FALSE, message=FALSE, error=F}
base::load("data/rawdata/Fulldata_adults.RData")
hunted.ad$site <- as.factor(hunted.ad$site)
summary(hunted.ad[,c(3,7,8,9)])

#structure file to summarise genotypes
all.raw <- read.structure("data/rawdata/Microsat.adults.plus.unrelated.chicks.forstructure.stru", 
                         n.ind = 2078, n.loc = 14, onerowperind = F,
                         col.lab = 1, col.pop = 2, col.others = NULL,
                         row.marknames = 0, NA.char = "-9", pop = NULL, 
                         sep = NULL,ask = F, quiet = TRUE) 

summary(all.raw)
```
# Test for Hardy-Weinberg equilibrium

We tested for Hardy-Weinberg equilibrium in the combined dataset consisting of adults and unrelated chicks (one chick per brood).

```{r hardyweinberg, warning=FALSE, message=FALSE}

#### Calculate Hardy-Weinberg equilibrium ####

# First all together
allHWE.all <- pegas::hw.test(all.raw, B = 1000) 
#B = 1000 for 1000 Monte Carlo permutations 
summary(allHWE.all )

# Then per population using a for loop
allpop <- seppop(all.raw)
# Run loop
allHWE = NULL
for(i in 1:length(allpop)) {
  hwt <- pegas::hw.test(allpop[[i]], B=1000)
  smry <- summary(allpop[[i]])
  Hobs <- smry[[6]]
  Hexp <- smry[[7]]
  pexact <- hwt[,4] #hw.test does chi2 test and exact test. 
  #We use p-values of exact test which are given in 4th col
  qval.FDR <- p.adjust(pexact, method = "fdr")
  qval.bon <- p.adjust(pexact, method = "bonferroni")
  allHWE <- as.data.frame(cbind(allHWE, Hobs, Hexp, pexact, qval.FDR, qval.bon))
  
}

#then we transform the resulting allpop dataframe into something readable (hidden)
```
```{r hidden hardyweinberg, warning=FALSE, message=FALSE, include=F}
mypalette3 <- c("#EDEDFD","#C2C1EC","#9795DB","#6C69C9","#413DB8","#1611A7") #for later
sites<-rep(names(allpop[1:length(allpop)]),each=5)
allHWE <- rbind(allHWE, sites)
allHWE <- allHWE[c(nrow(allHWE),1:(nrow(allHWE)-1)),]
rownames(allHWE)[1] <- "Site"

allHWE.t <- as.data.frame(t(allHWE))
nums <- c(2:15)
allHWE.t[nums] <- lapply(allHWE.t[nums], as.numeric)

allHWE.t[,c(2:15)]<- round(allHWE.t[,c(2:15)], 2)
```
```{r results hardyweinberg, warning=FALSE, message=FALSE, include=TRUE}

#### Results Hardy-Weinberg ####

head(allHWE.t) #HWE per locus per site

```
This table includes observed heterozygosity (Hobs), expected heterozygosity (Hexp), pexact, qval.FDR and qval.bon for each locus in (columns) for each site (1-12). The full output of the table can be found in Supplementary Table 3. We included a threshold in which a locus was excluded if the FDR-corrected value was lower than 0.05 in over 70% of the sites. Subsequently, we exclude locus 1 and 13 (locus 1 is not included in the manuscript as it resulted in PCA plots for females with very unexpected patterns (erogenous clustering)), most likely due to some genotyping and/or scoring error.

---
# Analysing population structure

To investigate patterns of genetic differentiation, we calculated
pairwise F~ST~ values and conducted a STRUCTURE analysis. 
Here, we go through calculating summary statistics, constructing a PCA to
get a grasp of the distribution of our data and identify potential outliers, 
and calculating the pairwise F~ST~ values for adult males, adult females and 
chicks separately.

Moreover, we compare observed and expected heterozygosity as well as 
allelic richness between hunted and unhunted sites, through modelling the effect of hunting on these three genetic diversity measures.

```{r fst, warning = FALSE, message=FALSE,fig.height=5,fig.width=8}


#using filtered structure files excluding loci out of HWE
all <- read.structure("data/cleandata/Microsat.adults.plus.unrelated.chicks.noLOCUS1+13.forstructure.stru", 
                       n.ind = 2078, n.loc = 12, onerowperind = F,
                       col.lab = 1, col.pop = 2, col.others = NULL,
                       row.marknames = 0, NA.char = "-9", 
                       pop = NULL, sep = NULL,
                       ask = F, quiet = FALSE)

#### Summary statistics ####

# This is based on adults and unrelated chicks across all loci
basicstat.all <- basic.stats(all, diploid = TRUE, digits = 2) 
allelic.richness.all <- allelic.richness(all, diploid = TRUE)

#Ar
allelic.richness.all.df <- as.data.frame(allelic.richness.all$Ar)
head(allelic.richness.all.df)
# full table of allelic richness can be found in Supplementary Table 1

#get mean Ho and Hx per pop
x.pop = seppop(all) 
summary.by.pop = lapply(x.pop, summary) 
Hobs.ls = rep(NA, length(summary.by.pop)) 
for (i in 1:length(summary.by.pop)){ 
  Hobs.ls[i] = mean(summary.by.pop[[i]]$Hobs, na.rm=TRUE) 
} 
Hobs.ls

Hexp.ls = rep(NA, length(summary.by.pop)) 
for (i in 1:length(summary.by.pop)){ 
  Hexp.ls[i] = mean(summary.by.pop[[i]]$Hexp, na.rm=TRUE) 
} 
Hexp.ls

#### PCA ####
basic.stats(all)
x <- tab(all, freq=TRUE, NA.method="mean")
pca <- dudi.pca(df = x, center = TRUE, scale = FALSE, scannf = FALSE, nf = 3)
s.class(pca$li, fac=pop(all), col=funky(15), sub = "PCA all")

```

```{r calculate Fst, warning = F, message = F}
#### Calculate Fst ####

#convert to hfstat object
all.hfstat <- genind2hierfstat(all)
#calculate statsf
basicstat.all <- basic.stats(all, diploid = TRUE, digits = 2) 

# per locus
fst.all.perlocus <- basicstat.all$perloc$Fst
fst.all.perlocus <- data.frame(Locus = seq(from = 1, to = 12), Fst = fst.all.perlocus)

# Pairwise Fst
fst.all <- pairwise.neifst(all.hfstat)
head(fst.all)

# Fst per population
boxplot(fst.all, col=funky(nPop(all)), las=3,
        xlab="Population", ylab="Fst", main = "Pairwise Fst values per population") 
#Bootstrap
boot.fst.all <- boot.ppfst(all.hfstat, nboot = 1000) 

```

```{r hidden calculate Fst, warning = F, message = F, include = FALSE}
#create a long dataframe for pairwise Fst
boot.fst.all.UL <- boot.fst.all$ul
boot.fst.all.LL <- boot.fst.all$ll

flat.matrix <- function(d){
  data.frame(i=rep(row.names(d),ncol(d)),
             j=rep(colnames(d),each=nrow(d)),
             score=as.vector(d))
}

fst.all.flat <- flat.matrix(fst.all)
names(fst.all.flat) <- c("site.x", "site.y", "Fst")

boot.fst.all.LL.flat <- flat.matrix(boot.fst.all.LL)
names(boot.fst.all.LL.flat) <- c("site.x", "site.y", "LL")

boot.fst.all.UL.flat <- flat.matrix(boot.fst.all.UL)
names(boot.fst.all.UL.flat) <- c("site.x", "site.y", "UL")

pairwise.fst.all <- left_join(fst.all.flat, boot.fst.all.LL.flat, by = c("site.x", "site.y"))
pairwise.fst.all <- left_join(pairwise.fst.all, boot.fst.all.UL.flat, by = c("site.x", "site.y"))

pairwise.fst.all <- subset(pairwise.fst.all, site.x != "-9" & site.y != "-9")
pairwise.fst.all <- subset(pairwise.fst.all, !is.na(Fst) & !is.na(UL))
pairwise.fst.all <- pairwise.fst.all %>% mutate(Significance = case_when(
  UL > 0 & LL > 0 ~ "significant",
  UL > 0 & LL < 0 ~ "insignificant",
  UL < 0 & LL < 0 ~ "significant" ))

pairwise.fst.all <- pairwise.fst.all %>% mutate(Sig = case_when(
  UL > 0 & LL > 0 ~ "",
  UL > 0 & LL < 0 ~ "NS",
  UL < 0 & LL < 0 ~ "" ))

pairwise.fst <- read.csv("tables/Pairwise_Fst_all.csv")

#change the negative values to 0 
pairwise.fst$Fst[which (pairwise.fst$Fst < 0)] <- 0

# add abbreviation to data
sitenames <- read.csv("data/details/Codes.pops.both.filtered_withcoord.csv")
# add abbreviations to sitenames
sitenames[1]
sitenames$abb <- c("KOS", "KUM", "LAU", "LEH", "NYR", "PAL", "PIH", "PIL", "PIS", "SAA", "TEE", "UTU")
str(sitenames)

pairwise.fst <- left_join(pairwise.fst, sitenames[,c(1,6,2)], by = c("site.x" = "pop_num"))
pairwise.fst <- left_join(pairwise.fst, sitenames[,c(1,6,2)], by = c("site.y" = "pop_num"))

# contains abbreviations
```
```{r plot Fst, warning = F, message = F, fig.height=7, fig.width=8}
 #purples from structure
ggplot(pairwise.fst, aes(abb.x, abb.y, fill = Fst)) + geom_tile() + theme_classic() + 
  scale_fill_gradientn(colors = mypalette3, limits = c(0,0.02)) + 
  geom_text(aes(label = Sig), size = 8)+
  theme(text = element_text(size = 22),
        axis.text.x = element_text(angle = 90, size = 26,
                                   face = c("bold", "plain", "bold", "plain", "plain",
                                            "bold", "bold", "plain", "bold",
                                            "plain", "plain")), 
        axis.text.y = element_text(size = 26, 
                                   face = c("plain", "bold", "plain", "plain",
                                            "bold", "bold", "plain", "bold",
                                            "plain", "plain", "bold")),
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        legend.text = element_text(size = 26),
        legend.title = element_text(size = 26),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 38),
        legend.position = c(0.8, 0.3)) +
  ggtitle('Fst heatmap') 

```




# Structure analysis

We used ParallelStructure to run STRUCTURE on multiple cores. Details on 
inferring the highest likelihood K and plotting the barcharts can be 
found in the full script within the GitHub directory called 
3.STRUCTUREanalysis.R.

Ensure you have enough computational power to conduct this analysis.

```{r structure, warning=FALSE, message=FALSE, eval=FALSE}

##### Running structure #####

all <- fread("data/cleandata/Microsat.adults.plus.unrelated.
             chicks.noLOCUS1+13.forstructure.stru")

infile <- "/data/home/rchen/Hunting/blackgrouse-hunting/data/
cleandata/Microsat.adults.plus.unrelated.chicks.noLOCUS1+13.forstructure.stru"

outpath <- "/data/home/rchen/Hunting/blackgrouse-hunting/analyses/
structure/results/"

# job matrix and write to job file
nrep <- 10
burnin <- 10000
niter <- 10000
up_to_k <- 12

# job matrix
k_var <- rep(1:up_to_k, each = nrep)
ID_var <- as.character(sapply(c(1:up_to_k), function(k) 
  sapply(c(1:nrep), function(x) paste0("T",k, "_", x))))

# make the job matrix
pop <- "1,2,3,4,5,6,7,8,9,10,11,12" #number of pops in the file

hunt_jobs <- matrix(c(ID_var, rep(pop, nrep * up_to_k), k_var, 
                      rep(burnin, nrep * up_to_k),
                      rep(niter, nrep * up_to_k)), nrow = nrep * up_to_k)

write(t(hunt_jobs), ncol = length(hunt_jobs[1,]), 
      file = "analyses/structure/structure_jobs.txt")

# file path to structure

STR_path='/usr/local/bin/'

# Run Parallel Structure

# Run structure (from terminal, do not run this last part in Rstudio)

parallel_structure(structure_path=STR_path,
                                      joblist='analyses/structure/structure_jobs.txt',
                   n_cpu=45, infile=infile,
                   outpath=outpath,
                   numinds = nrow(all)/2,
                   numloci=ncol(all)-2,
                   noadmix = 0, alpha = 1.0, freqscorr=1,
                   lambda = 1,
                   printqhat=1, plot_output=0, 
                   onerowperind=0, locprior = 0)


```

These STRUCTURE analyses gave us the following results:


```{r plots structure, echo=F, message=F, warning=F, fig.height=5, fig.weight=6}

###Supplementary Figure 1: log likelihood per K (STRUCTURE) ##### 

ks_all <- read.csv("analyses/structure/results/Run_files/output.csv")

## plotting K vs mean log likelihood
ggplot(ks_all, aes(x = k, y = elpdmean)) +
  geom_point(col="black") + geom_line(col="black")+ ylab("LnPr(X|k)") +
  scale_x_continuous(name = "k", 
                     breaks = c(1:12),
                     labels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12")) +
  scale_y_continuous(breaks = c(-40000, -36000, -32000),
                     labels = c("-40K", "-36K", "-32K"))+
  geom_errorbar(aes(ymin = elpdmin, ymax = elpdmax), width = 0.1, col = "gray45") +
  theme_classic() +
  theme(axis.title = element_text(face = "bold"),
        axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 22),
        plot.title = element_text(size = 22)) 

```
# Effect of hunting on genetic diversity 

To understand the effect of hunting on genetic diversity, we first conduct a t-test comparing observed heterozygosity, expected heterozygosity and allelic richness between hunted and unhunted populations. Next, we construct a lm to include random effects of locus and population on the genetic diversity measures.

```{r hidden genetic diversiy, include = F, warning = F, message=F}
pops <- read.csv("data/details/Codes.pops.both.filtered_withcoord.csv")
pops$pop_num <- as.character(pops$pop_num)
measures <- data.frame(pop = names(summary.by.pop), Hobs = Hobs.ls, 
                       Hexp = Hexp.ls, Ar = colMeans(allelic.richness.all.df, na.rm = T))
measures <- left_join(measures, pops[,c(2,3)], by = c("pop" = "pop_num"))

# let's also do it including all data per locus, and model with locus as random factor
Hobs.all <- NULL

for (i in 1:length(summary.by.pop)){
  Hobs.i <- data.frame(locus= c(names(summary.by.pop[[i]]$Hobs)),
                       pop = names(summary.by.pop[i]),
                       Hobs = c(summary.by.pop[[i]]$Hobs))
  Hobs.all <- rbind(Hobs.all, Hobs.i)
  rownames(Hobs.all) <- NULL
}

Hexp.all <- NULL

for (i in 1:length(summary.by.pop)){
  Hexp.i <- data.frame(locus= c(names(summary.by.pop[[i]]$Hexp)),
                       pop = names(summary.by.pop[i]),
                       Hexp = c(summary.by.pop[[i]]$Hexp))
  Hexp.all <- rbind(Hexp.all, Hexp.i)
  rownames(Hexp.all) <- NULL
}

Ar.all <- NULL

for (i in 1:ncol(allelic.richness.all.df)){
  Ar.i <- data.frame(locus= c(rownames(allelic.richness.all.df[i])),
                       pop = colnames(allelic.richness.all.df[i]),
                       Ar = c(allelic.richness.all.df[,i]))
  Ar.all <- rbind(Ar.all, Ar.i)
  rownames(Ar.all) <- NULL
}

measures.all <- left_join(Hobs.all, Hexp.all) %>% left_join(Ar.all) %>% left_join(pops[,c(2,3)], by = c("pop" = "pop_num"))

measures.all
measures.all$locus <- as.factor(measures.all$locus)
measures.all$pop <- as.factor(measures.all$pop)
measures.all$hunt <- as.factor(measures.all$hunt)

```

```{r Compare genetic diversity, warning = F, message=F}

## First: t-test to compare differences in genetic diversity between 
## hunted vs unhunted sites (where we have the mean value of all loci per site)

head(measures)

t.test(measures$Hobs[which(measures$hunt == "hunted")], 
       measures$Hobs[which(measures$hunt == "unhunted")])

t.test(measures$Hexp[which(measures$hunt == "hunted")], 
       measures$Hexp[which(measures$hunt == "unhunted")])

t.test(measures$Ar[which(measures$hunt == "hunted")], 
       measures$Ar[which(measures$hunt == "unhunted")])

## Then, we model the effect of hunting on the three genetic diversity measures,
## where we take each measure per locus per site and perform a likelihood
## ratio test to assess the difference between the null and alternative model

head(measures.all)

# excluding BG20 (out of HWE)
Ho_model <- lmerTest::lmer(Hobs ~ hunt + (1|locus) + (1|pop), 
                           data = subset(measures.all, locus != "L13")) 

Ho_model_null <- lmerTest::lmer(Hobs ~ (1|locus) + (1|pop), 
                                data = subset(measures.all, locus != "L13")) 

He_model <- lmerTest::lmer(Hexp ~ hunt + (1|locus) + (1|pop), 
                           data = subset(measures.all, locus != "L13"))
He_model_null <- lmerTest::lmer(Hexp ~ (1|locus) + (1|pop), 
                                data = subset(measures.all, locus != "L13"))

Ar_model <- lmerTest::lmer(Ar ~ hunt + (1|locus) + (1|pop), 
                           data = subset(measures.all, locus != "L13"))
Ar_model_null <- lmerTest::lmer(Ar ~ (1|locus) + (1|pop), 
                                data = subset(measures.all, locus != "L13"))

#LRT
anova(Ho_model, Ho_model_null) # no significant difference
anova(He_model, He_model_null) # no significant difference
anova(Ar_model, Ar_model_null) # no significant difference

```
# Calculating and modelling sMLH

To quantify inbreeding levels, we calculated sMLH using the inbreedR package.
Then, to understand the effects of hunting on inbreeding, we built a 
mixed-model and investigated the fit of the models.


```{r smlh modelsetup, warning=F, echo=F, message=F, fig.height=5, fig.weight=5}
# Loaded in clean version of sMLH and split by sex/age class
load(file = "data/cleandata/sMLH.all.RData")

## Look at distribution sMLH ##

ggplot(subset(sMLH.all, sex == "m" & age == "adult"), aes(x=sMLH)) + 
  geom_histogram() +theme_classic() +
  labs(title = "Histogram of sMLH for adult males")

ggplot(subset(sMLH.all,sex == "f" & age == "adult"), aes(x=sMLH)) + 
  geom_histogram() +theme_classic() +
  labs(title = "Histogram of sMLH for adult females")

ggplot(subset(sMLH.all,age == "chick"), aes(x=sMLH)) + geom_histogram() +
  theme_classic() +
  labs(title = "Histogram of sMLH for unrelated chicks")

# not perfectly normal. also tried the below models with 
# both a poisson and gamma distribution, which had a bad fit
```

```{r smlh modelling, warning=F, message=F}

### Setup models ####
sMLH.all.no.na <- subset(sMLH.all, !is.na(density)) 
#exclude those without density otherwise lrt won't work

sMLH.model.all.lmer <- lmerTest::lmer(sMLH ~ 
                                        hunt*density + sex + age+ (1|pop), 
                                      data = sMLH.all.no.na)
sMLH.model.all.lmer.noint <- lmerTest::lmer(sMLH ~ 
                                              hunt + sex + age+ density + (1|pop), 
                                            data = sMLH.all.no.na)
sMLH.model.all.lmer.null <- lmerTest::lmer(sMLH ~ 
                                             density+ sex + age+ (1|pop), 
                                           data = sMLH.all.no.na)

anova(sMLH.model.all.lmer.null, sMLH.model.all.lmer)
anova(sMLH.model.all.lmer.null, sMLH.model.all.lmer.noint)

coef(summary(sMLH.model.all.lmer))
VarCorr(sMLH.model.all.lmer)
simulateResiduals(fittedModel = sMLH.model.all.lmer, plot = T)
plot(sMLH.model.all.lmer)
r.squaredGLMM(sMLH.model.all.lmer)
icc(model = sMLH.model.all.lmer, by_group = TRUE)

compare_performance(sMLH.model.all.lmer.null, sMLH.model.all.lmer, rank = T)
compare_performance(sMLH.model.all.lmer.null, sMLH.model.all.lmer.noint, rank = T)
```

# Migration models

Next, we investigated patterns of dispersion and how these are affected
by hunting. We used BA3 to calculate migration directions and rates,
followed by building mixed models to estimate the effect of hunting on migration.

```{r calculate migration, warning=F, message=F,eval=FALSE}
#### Running BA3 ####

#install BA3, run through command line/terminal

#5 runs with 5 different random seeds
system("~/bin/BA3/BA3MSAT -v -t -g -u -a 0.30 -f 0.40 -s 65323 -i 10000000 
       -b 1000000 -n 500 -o run1_nohwe.txt 
       analyses/migrationanalysis/data_all_ba3_allloci.txt") #repeat for another 4 runs

```
```{r hidden migration,message=F, warning=F, echo=F}
#### Compare all 5 runs ####
temp <- list.files(path = "analyses/migrationanalysis/BA3runs", 
                   pattern = "*nohwe.txt", full.names=T)
myfiles = lapply(temp, fread, skip = 18, nrows = 12, header = F)

# formula for reshaping the dataframes

reshape_ba3 <- function(m) {
  m1 <- m[,c(1,2)]
  names(m1) <- c("pops", "migration")
  m2 <- m[,c(3,4)]
  names(m2) <- c("pops", "migration")
  m3 <- m[,c(5,6)]
  names(m3) <- c("pops", "migration")
  m4 <- m[,c(7,8)]
  names(m4) <- c("pops", "migration")
  m5 <- m[,c(9,10)]
  names(m5) <- c("pops", "migration")
  m6 <- m[,c(11,12)]
  names(m6) <- c("pops", "migration")
  m7 <- m[,c(13,14)]
  names(m7) <- c("pops", "migration")
  m8 <- m[,c(15,16)]
  names(m8) <- c("pops", "migration")
  m9 <- m[,c(17,18)]
  names(m9) <- c("pops", "migration")
  m10 <- m[,c(19,20)]
  names(m10) <- c("pops", "migration")
  m11 <- m[,c(21,22)]
  names(m11) <- c("pops", "migration")
  m12 <- m[,c(23,24)]
  names(m12) <- c("pops", "migration")
  mnew<-rbind(m1, m2, m3, m4, m5,m6,m7,m8,m9,m10,m11,m12)
  mnew$m_in <- c(rep(c(1:12), times = 12, each = 1)) 
  mnew$m_out <- c(rep(c(1:12), times = 1, each = 12)) 
  mnew <- separate(data = mnew, col = "migration", into = c("migration", "migration_SE"), 
                   sep = "[(]") #seperate migration and its SE
  mnew$migration_SE <- gsub(mnew$migration_SE, pattern = "[)]", replacement = "") 
  mnew <- mnew[,c(4,5,2,3)]
  return(mnew)
}

# run it for all files
for (i in 1:length(myfiles)) {
  myfiles[[i]]<-reshape_ba3(myfiles[[i]])
}

#separate per run to compare
run1 <- myfiles[[1]]
run2 <- myfiles[[2]]
run3 <- myfiles[[3]]
run4 <- myfiles[[4]]
run5 <- myfiles[[5]]
```
```{r migration compare, warning=F,message=F,tidy=TRUE}
#### Compare runs ####
plot(run1$migration, run2$migration)
# plot(run1$migration, run3$migration) #hide these in RMarkdown
# plot(run1$migration, run4$migration)
# plot(run1$migration, run5$migration)
# plot(run2$migration, run3$migration)
# plot(run2$migration, run4$migration)
# plot(run2$migration, run5$migration)
# plot(run3$migration, run4$migration)
# plot(run3$migration, run5$migration)
plot(run4$migration, run5$migration)
# all runs correspond

## Going to pick run 5 for both
```

```{r migrationclean, warning=F,message=F,tidy=TRUE, echo=F, fig.height=5, fig.weight=6}
#### Load in cleaned migration files ####
# see R script 5.migrationmodels.R for details on how BA3 were cleaned
# Briefly: raw BA3 files were merged with with ESS (effective sample size), and those with an ESS < 200 were set to NA, hunted status and distance between sites were also added

run5_clean <- read.csv("analyses/migrationanalysis/run5_clean.csv")

head(run5_clean)
### Plotting migration rates from run 5 ####
#first, exclude the 'non-migration rates' which are those where pop in = pop out
run5_clean <- subset(run5_clean, m_in != m_out)

theme_set(theme_classic())
# out hunted vs out unhunted but exclude nonmigration rates

ttest_in_rates <- t.test(run5_clean$migration_ESSc[which(run5_clean$hunt_in == "hunted" & run5_clean$m_in != run5_clean$m_out)], run5_clean$migration_ESSc[which(run5_clean$hunt_in == "unhunted" & run5_clean$m_in != run5_clean$m_out)])

ggplot(run5_clean, aes(x = hunt_in, y = migration_ESSc)) + geom_boxplot(aes(fill = "Type")) +
  labs(title = "Migration rates IN") + xlab("Hunted status") + ylab("migration rates in")+
  labs(subtitle = 
         paste("Excluding values with ESS < 200 
Student t-test comparing hunted/unhunted site filtered migration rate in: 
t = ", round(ttest_in_rates$statistic,2), "and p-value = ", round(ttest_in_rates$p.value, 2)))+ 
  theme(text = element_text( size = 22),
        plot.subtitle = element_text(size = 14),
        legend.position = "none")+
  scale_fill_manual(values = c("cyan3"))

# in hunted vs in unhunted but exclude nonmigration_ESSc rates

ttest_out_rates <- t.test(run5_clean$migration_ESSc[which(run5_clean$hunt_out == "hunted")], run5_clean$migration_ESSc[which(run5_clean$hunt_out == "unhunted")])

ggplot(run5_clean, aes(x = hunt_out, y = migration_ESSc, fill = "blue")) + geom_boxplot(aes(fill = "Type")) +
  labs(title = "Migration rates OUT") + xlab("Hunted status") + ylab("migration rates out")+
  labs(subtitle = 
         paste("Excluding values with ESS < 200 
Student t-test comparing hunted/unhunted site corrected migration rate out: 
t = ", round(ttest_out_rates$statistic,2), "and p-value = ", round(ttest_out_rates$p.value, 3)))+ 
  theme(text = element_text(size = 22),
        plot.subtitle = element_text(size = 14),
        legend.position = "none")+
  scale_fill_manual(values = c("cyan3"))
```
```{rmigration models, warning=F,message=F,tidy=TRUE}
#### Modelling migration ####

#change levels hunted/unhunted
run5_clean$hunt_in <- relevel(as.factor(run5_clean$hunt_in), ref = "unhunted")
run5_clean$hunt_out <- relevel(as.factor(run5_clean$hunt_out), ref = "unhunted")

#immigration

model.in <- glmmTMB(migration_ESSc~ hunt_in + Distance +  (1|pop_out) + (1|pop_in), 
                         data = run5_clean, 
                         family = Gamma(link = "log"))

model.in.null <- glmmTMB(migration_ESSc~ Distance +  (1|pop_out) + (1|pop_in), 
                         data = run5_clean, 
                         family = Gamma(link = "log"))

anova(model.in, model.in.null)

summary(model.in) 
simulateResiduals(fittedModel = model.in, plot = T)

#out

model.out <- glmmTMB(migration_ESSc~ hunt_out + Distance + (1|pop_out) + (1|pop_in), 
                          data = run5_clean, 
                          family = Gamma(link = "log"))
model.out.null <- glmmTMB(migration_ESSc~ Distance + (1|pop_out) + (1|pop_in), 
                          data = run5_clean, 
                          family = Gamma(link = "log"))

anova(model.out, model.out.null)

summary(model.out) 
simulateResiduals(fittedModel = model.out, plot = T)

compare_performance(model.in, model.in.null, rank=T)
compare_performance(model.out, model.out.null, rank=T)

```

# Other plots included in the manuscript

Figure 1 was created with qGIS, for barcharts of STRUCTURE output as in 
Supplementary Figure 2, please refer to R script 6.CreatingPlots.R


```{r plots, warning=F, message=F, fig.height=5, fig.weight=5}

### Figure 2 - correlograms
spatial <- read_excel("tables/SpatialAutocor_04.10.22.xlsx", sheet = "ForR")

### Males - spatial
spatial %>% filter(Who == "Male") %>% ggplot(aes(x = What)) + 
  geom_line(aes(y = r), col = "#8989D0", size = 1.5) + theme_classic() + 
  geom_hline(yintercept = 0, col = "black")+
  geom_ribbon(aes(ymax = U, ymin = L), fill = "#8989D0", alpha = 0.5)+
  geom_errorbar(aes(y = r, ymin = r-Le, ymax = r+Ue), width=1, 
                size=1.5, color="black", stat = "identity")+
  ylim(-0.03, 0.035) +
  xlab("Distance class") + ylab("Autocorrelation coefficient r")+
  scale_x_continuous(breaks = c(seq(0, 60, by = 10)), limits=c(4,61))+
  theme(text = element_text(size = 14),
        plot.title = element_text(size = 38),
        axis.text.x = element_text(size = 26, margin = margin(b = 10)), 
        axis.text.y = element_text(size = 26, margin = margin(l = 10)),
        axis.title.x = element_text(size = 30), 
        axis.title.y = element_text(size = 30)) 

### Females - spatial

spatial %>% filter(Who == "Females") %>% ggplot(aes(x = What)) + 
  geom_line(aes(y = r), col = "#8989D0", size = 1.5) + theme_classic() + 
  geom_hline(yintercept = 0, col = "black")+
  geom_ribbon(aes(ymax = U, ymin = L), fill = "#8989D0", alpha = 0.5)+
  geom_errorbar(aes(y = r, ymin = r-Le, ymax = r+Ue), width=1, size=1.5, 
                color="black", stat = "identity")+
  ylim(-0.03, 0.035) +
  xlab("Distance class") + ylab("Autocorrelation coefficient r")+
  scale_x_continuous(breaks = c(seq(0, 60, by = 10)), limits=c(4,61))+
  theme(text = element_text(size = 14),
        plot.title = element_text(size = 38),
        axis.text.x = element_text(size = 26, margin = margin(b = 10)), 
        axis.text.y = element_text(size = 26, margin = margin(l = 10)),
        axis.title.x = element_text(size = 30), 
        axis.title.y = element_text(size = 30))


### Chicks - spatial
spatial %>% filter(Who == "Unrelated_chicks") %>% ggplot(aes(x = What)) + 
  geom_line(aes(y = r), col = "#8989D0", size = 1.5) + theme_classic() + 
  geom_hline(yintercept = 0, col = "black")+
  geom_ribbon(aes(ymax = U, ymin = L), fill = "#8989D0", alpha = 0.5)+
  geom_errorbar(aes(y = r, ymin = r-Le, ymax = r+Ue), width=1, size=1.5, 
                color="black", stat = "identity")+
  ylim(-0.03, 0.035) +
  xlab("Distance class") + ylab("Autocorrelation coefficient r")+
  scale_x_continuous(breaks = c(seq(0, 60, by = 10)), limits=c(4,61))+
  theme(text = element_text(size = 14),
        plot.title = element_text(size = 38),
        axis.text.x = element_text(size = 26, margin = margin(b = 10)), 
        axis.text.y = element_text(size = 26, margin = margin(l = 10)),
        axis.title.x = element_text(size = 30), 
        axis.title.y = element_text(size = 30)) 

### Figure 3: boxplots migration rates ####
run5_clean <- read.csv("analyses/migrationanalysis/run5_clean.csv")

#change levels
run5_clean$hunt_in <- relevel(as.factor(run5_clean$hunt_in), ref = "unhunted")
run5_clean$hunt_out <- relevel(as.factor(run5_clean$hunt_out), ref = "unhunted")

#first, exclude the 'non-migration rates' which are those where pop in = pop out
run5_clean <- subset(run5_clean, m_in != m_out)

# plot emigration rates 
ggplot(run5_clean, aes(x = hunt_out, y = migration_ESSc, fill = "#57939a")) + 
  geom_boxplot(outlier.shape = NA, aes(middle = mean(migration_ESSc))) + ylim(0, 0.03)+
  labs(title = "(a) Emigration rates") + 
  ylab("Migration rate")+
  theme(text = element_text(size = 26),
        legend.text = element_text(size = 28),
        legend.title = element_text(size = 28),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 38),
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        legend.position = "none")+
  scale_fill_manual(values=c("#57939a"))

#plot immigration rates

ggplot(run5_clean, aes(x = hunt_in, y = migration_ESSc, fill = "#be4d5a")) + 
  geom_boxplot(outlier.shape = NA, aes(middle = mean(migration_ESSc))) + ylim(0, 0.03)+
  labs(title = "(b) Immigration rates") + 
  ylab("Migration rate")+
  theme(text = element_text(size = 26),
        legend.text = element_text(size = 28),
        legend.title = element_text(size = 28),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 38),
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        legend.position = "none")+
  scale_fill_manual(values = c("#be4d5a"))+geom_text(x = 1.5, y = 0.028, label = "*", size = 10) + geom_segment(x = 1, xend = 2, y = 0.025, yend = 0.025)+
  geom_segment(x=1, xend = 1, y = 0.025, yend = 0.024)+geom_segment(x=2, xend = 2, y = 0.025, yend = 0.024)

```

See below session information including package versions.

``` {r setup, warning=F,message=F, tidy=TRUE}
session_info()
```